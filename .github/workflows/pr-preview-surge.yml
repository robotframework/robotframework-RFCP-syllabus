name: PR Preview (Surge, gated by review)

on:
  # Use pull_request_target so secrets/env can be used after manual approval
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, edited, labeled]
  # Optional: teardown on close
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read
  issues: write    # to comment preview URL

env:
  SURGE_DOMAIN_BASE: ${{ github.event.repository.name }}

jobs:
  build:
    # Build untrusted code WITHOUT secrets
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    name: Build PR
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./website
    steps:
      - name: Checkout PR head (read-only)
        uses: actions/checkout@v4
        with:
          # IMPORTANT: check out the PR's HEAD repo/ref explicitly and disable credentials
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn
          cache-dependency-path: website/yarn.lock

      - name: Install deps
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-build
          path: website/build
          if-no-files-found: error
          retention-days: 5

  deploy:
    # Will pause at Environment gate until a member approves
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    name: Deploy Preview to Surge (requires approval)
    needs: build
    runs-on: ubuntu-latest

    # ðŸ‘‡ Create an Environment named "preview" in repo settings.
    # Add SURGE_TOKEN as an Environment secret there.
    # Configure "Required reviewers" so a repo member must approve.
    environment:
      name: preview
      url: ${{ steps.deployed.outputs.preview_url }}

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-build
          path: ./build

      - name: Install Surge CLI
        run: npm i -g surge

      - name: Compute preview domain
        id: dom
        run: |
          echo "domain=${{ env.SURGE_DOMAIN_BASE }}-pr-${{ github.event.number }}.surge.sh" >> $GITHUB_OUTPUT

      - name: Deploy to Surge
        id: deployed
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}   # from the "preview" Environment
        run: |
          surge --project ./build \
                --domain ${{ steps.dom.outputs.domain }} \
                --token "$SURGE_TOKEN"
          echo "preview_url=https://${{ steps.dom.outputs.domain }}" >> $GITHUB_OUTPUT

      - name: Comment with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deployed.outputs.preview_url }}'
            const body = `ðŸš€ Preview deployed to **${url}**`
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

  teardown:
    # Optional: remove preview when the PR closes
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    name: Teardown Surge preview
    runs-on: ubuntu-latest
    steps:
      - name: Install Surge CLI
        run: npm i -g surge
      - name: Compute preview domain
        id: dom
        run: |
          echo "domain=${{ github.event.repository.name }}-pr-${{ github.event.number }}.surge.sh" >> $GITHUB_OUTPUT
      - name: Teardown
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}   # you can reuse the same Environment by adding environment: preview if you want review-gated teardown
        run: |
          surge teardown "${{ steps.dom.outputs.domain }}" --token "$SURGE_TOKEN" || true
